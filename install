#!/bin/bash

#-----------
# Configurations
#-----------

POSTGRES_LAUNCHER_DIR=${POSTGRES_LAUNCHER_DIR-/var/local/postgres}
POSTGRES_LOG_DIR=${POSTGRES_LOG_FILE-/var/log/postgres}
POSTGRES_DATA_DIR=${POSTGRES_DATA_DIR-/var/local/postgres/data}
POSTGRES_PORT=${POSTGRES_PORT-5432}
POSTGRES_ADMIN_USERNAME=${POSTGRES_ADMIN_USERNAME-admin}
POSTGRES_ADMIN_PASSWORD=${POSTGRES_ADMIN_PASSWORD-yth3fn0t}
DEBUG=${DEBUG-false}

#-----------
# Install Script
#-----------

echo "Installing POSTGRES..."

mkdir -p ${POSTGRES_LAUNCHER_DIR}/config ${POSTGRES_LOG_DIR} ${POSTGRES_DATA_DIR}

cp ./submodules/postgres/files/postgres.dockerfile ${POSTGRES_LAUNCHER_DIR}/Dockerfile
cp -u ./submodules/postgres/files/psqlentry ${POSTGRES_LAUNCHER_DIR}/config/psqlentry


if [[ "$DEBUG" == true ]]; then
  (cd ${POSTGRES_LAUNCHER_DIR} && docker build -t postgres .)
else
  (cd ${POSTGRES_LAUNCHER_DIR} && docker build -t postgres .) >> /dev/null
fi

echo "#!/bin/bash
docker run -i -t \\
  -v ${POSTGRES_LOG_DIR}:/log \\
  -v ${POSTGRES_DATA_DIR}:/var/lib/postgresql/data \\
  --link postgres:psqldb \\
  postgres /bin/bash
" > ${POSTGRES_LAUNCHER_DIR}/debug

printf "%b" "#!/bin/bash
docker rm postgres > /dev/num
docker run -d -t \\
  -p ${POSTGRES_PORT}:5432 \\
  -v ${POSTGRES_LOG_DIR}:/log \\
  -v ${POSTGRES_DATA_DIR}:/var/lib/postgresql/data \\
  --name postgres \\
  postgres
" > ${POSTGRES_LAUNCHER_DIR}/start

NAME=postgres DIR=$POSTGRES_LAUNCHER_DIR ./submodules/docker/stop
NAME=postgres DIR=$POSTGRES_LAUNCHER_DIR ./submodules/docker/idempot
NAME=postgres DIR=$POSTGRES_LAUNCHER_DIR ./submodules/docker/ip

chmod 755 $POSTGRES_LAUNCHER_DIR/start
chmod 755 $POSTGRES_LAUNCHER_DIR/debug
chmod 755 $POSTGRES_LAUNCHER_DIR/ip

echo "Done, Installing POSTGRES."